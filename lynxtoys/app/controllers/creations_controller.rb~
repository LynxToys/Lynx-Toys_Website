class CreationsController < ApplicationController
  #def index
#	@creations = Creation.first
#	@id = @creations.creation_id
#	@pictures = Picture.where(creation_id: @id)
#  end
  def index
    @creations = Creation.all
    @sortCriteria = nil
    if params[:sort] != nil
      @sortCriteria = params[:sort]
    end
    if @sortCriteria == 'votes-rank'
      @creations = @creations.sort {|a,b| b.votes.count <=> a.votes.count}
    else
      @creations = @creations.sort {|a,b| b.created_at <=> a.created_at}
    end
  end
  
  def new
    @creation = Creation.new
  end
  
  def create
  	@creation = Creation.new(creation_params)
    if !verify_recaptcha(model: @creation, private_key: "6LciMwUTAAAAAHFDUOFGVx58aY66C_Bw5FZQ6Yt7") 
      flash[:warning] = "The data you entered for the CAPTCHA wasn't correct.  Please try again"
      redirect_to new_creation_path
    else
      flash[:notice] = 'Creation was successfully created.'
      respond_to do |format|
      	if @creation.save
      		if params[:images]
      	 	  params[:images].each { |image|
      			@creation.pictures.create(image: image)
      		  }
      		end
      		#@creation.cover.create(cover: params[:cover])
      		@cover = Cover.new
      		@cover.cover=params[:cover]
      		@cover.creation_id=@creation.id
      		@cover.save
      		format.html { redirect_to @creation }
          	format.json { render json: @creation, status: :created, location: @creation }
      	else
      		format.html { render action: "new" }
      	      #format.json { render json: @creation.errors, status: :unprocessable_entity }
      	end	
      end
      ManageMailer.sample_email(@creation).deliver
    end
  end
  
  def show
	@creation = Creation.find(params[:id])
  end

  def manage
	@creation = Creation.find(params[:id])
  end
  
  def accept
	@creation = Creation.find(params[:id])
	@creation.isAc = 1
	@creation.save
	redirect_to creations_path
  end
 
  def delete
    @creation = Creation.find(params[:id])
    @creation.destroy
    flash[:notice] = "Creation '#{@creation.name}' deleted."
    redirect_to creations_path
  end

  #def destroy
	#Creation.find(params[:id]).destroy
	#redirect_to(:action => 'index')
  #end

  def upvote
     flag = 0
     @creation = Creation.find(params[:id])
     @creation.votes.each do |v|
	if(v.vote_ip == request.remote_ip)
		flag = 1;
        end
     end
     if(flag == 0)
     	@creation.votes.create(vote_ip: request.remote_ip)
	flash[:notice] = 'Thanks for your voting!'
     else
        flash[:notice] = 'Thanks for your voting!'
     end
     redirect_to creation_path(@creation)
  end
  
  private
  
  def creation_params
	params.require(:creation).permit(:name,:creator_name,:description,:likes)
  end
end
